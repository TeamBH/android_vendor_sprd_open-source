#!/bin/sh

sprdDir=/data/sprdinfo
aprFile=${sprdDir}/apr.xml
gAprIsNotEmpty=true
gStartTime=`date +%s`
gAprXmlLines=0

setup()
{
	if [ ! -d "${sprdDir}" ];then
		mkdir ${sprdDir}
	fi
	if [ ! -f ${aprFile} ];then
		gAprIsNotEmpty=false
		echo "<?xml version=\"1.0\" encoding=\"utf-8\"?>" > ${aprFile}
		echo "<aprs>" >> ${aprFile}
		echo "</aprs>" >> ${aprFile}
	fi
}

addAprRecord()
{
	hardwareVersion=`getprop ro.product.hardware`
	SN=`getprop ro.boot.serialno`
	buildNumber=`getprop ro.build.description`
	for i in 1 2 3 4 5 6 7 8 9 10 9 8 7 6 5 4 3 2 1
	do
		CPVersion=`getprop gsm.version.baseband`
		if ! test -z "$CPVersion"
		then
			break;
		fi
		sleep $i
	done
	startTime=$gStartTime
	upTime=`cat /proc/uptime | busybox cut -d '.' -f 1`
	endTime=`busybox expr $startTime + $upTime`
	occurredTime=$endTime
	specialCause="normal"

	busybox sed -i '$d' ${aprFile}
	echo "\t<apr>" >> ${aprFile}
	echo "\t\t<hardwareVersion>${hardwareVersion}</hardwareVersion>" >> ${aprFile}
	echo "\t\t<SN>${SN}</SN>" >> ${aprFile}
	echo "\t\t<buildNumber>${buildNumber}</buildNumber>" >> ${aprFile}
	echo "\t\t<CPVersion>${CPVersion}</CPVersion>" >> ${aprFile}
	echo "\t\t<startTime>${startTime}</startTime>" >> ${aprFile}
	echo "\t\t<endTime>${endTime}</endTime>" >> ${aprFile}
	echo "\t\t<exceptions>" >> ${aprFile}
	echo "\t\t\t<entry>" >> ${aprFile}
	echo "\t\t\t\t<timestamp>${occurredTime}</timestamp>" >> ${aprFile}
	echo "\t\t\t\t<type>${specialCause}</type>" >> ${aprFile}
	echo "\t\t\t</entry>" >> ${aprFile}
	echo "\t\t</exceptions>" >> ${aprFile}
	echo "\t</apr>" >> ${aprFile}
	echo "</aprs>" >> ${aprFile}
}

updateSpecialCause()
{
	specialCause=`getprop ro.boot.mode`
	if ! test -z "$specialCause"
	then
		busybox sed -i '$d' ${aprFile}
		busybox sed -i '$d' ${aprFile}
		busybox sed -i '$d' ${aprFile}
		busybox sed -i '$d' ${aprFile}
		busybox sed -i '$d' ${aprFile}

		echo "\t\t\t\t<type>${specialCause}</type>" >> ${aprFile}
		echo "\t\t\t</entry>" >> ${aprFile}
		echo "\t\t</exceptions>" >> ${aprFile}
		echo "\t</apr>" >> ${aprFile}
		echo "</aprs>" >> ${aprFile}
	fi
}

updateTime()
{
	startTime=$gStartTime
	upTime=`cat /proc/uptime | busybox cut -d '.' -f 1`
	endTime=`busybox expr $startTime + $upTime`
	occurredTime=$endTime
	specialCause="normal"

	busybox sed -i '$d' ${aprFile}
	busybox sed -i '$d' ${aprFile}
	busybox sed -i '$d' ${aprFile}
	busybox sed -i '$d' ${aprFile}
	busybox sed -i '$d' ${aprFile}
	busybox sed -i '$d' ${aprFile}
	busybox sed -i '$d' ${aprFile}
	busybox sed -i '$d' ${aprFile}
	busybox sed -i '$d' ${aprFile}

	echo "\t\t<endTime>${endTime}</endTime>" >> ${aprFile}
	echo "\t\t<exceptions>" >> ${aprFile}
	echo "\t\t\t<entry>" >> ${aprFile}
	echo "\t\t\t\t<timestamp>${occurredTime}</timestamp>" >> ${aprFile}
	echo "\t\t\t\t<type>${specialCause}</type>" >> ${aprFile}
	echo "\t\t\t</entry>" >> ${aprFile}
	echo "\t\t</exceptions>" >> ${aprFile}
	echo "\t</apr>" >> ${aprFile}
	echo "</aprs>" >> ${aprFile}
}

# main
setup

gAprXmlLines=`busybox wc -l $aprFile | busybox cut -d ' ' -f 1`
if [ ${gAprXmlLines} -gt 16000 ]
then
	exit
fi

if [ ${gAprIsNotEmpty} = "true" ]
then
	updateSpecialCause
fi

addAprRecord

while true
do
	sleep 60
	if [ -f ${aprFile} ]
	then
		updateTime
	else
		break
	fi
done
